<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>MnistUi</title>

    <!-- Vue -->
    <script src="node_modules/vue/dist/vue.min.js"></script>

    <!-- jQuery -->
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script>
        var $ = require('jquery')
    </script>

    <!-- font -->
    <link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.min.css">

    <!-- bulma -->
    <link rel="stylesheet" href="node_modules/bulma/css/bulma.css">

    <!-- ipc -->
    <script>
        const ipcRenderer = require('electron').ipcRenderer;
        ipcRenderer.on('inimg-reply', function (event, arg) {
            console.log(arg);
        });
        ipcRenderer.on('binimg', function (event, arg) {
            console.log('bin img fin');
        });
        ipcRenderer.on('cut', function (event, arg) {
            console.log('cut fin');
            $('#preimg')[0].src = './data/data.min.png?' + Math.random();
        });
        ipcRenderer.on('error', function (event, arg) {
            console.log(arg);
            $('#verror').show();
            setTimeout(function () { $('#verror').hide(); }, 10000);
            $('#verify')[0].classList.remove('is-loading')
            $('#verify')[0].onclick = verifyNum;
        });
        ipcRenderer.on('errormsg', function (event, arg) {
            console.log(arg);
            vErrorNoti.errorMsg = arg;
        });
        ipcRenderer.on('finish', function (event, arg) {
            console.log('finish');
            $('#verify')[0].classList.remove('is-loading')
            $('#verify')[0].onclick = verifyNum;
            //vAnswer.answer = arg;
            console.log(arg);
            //$('#vanswer').show();
            $('#number')[0].value = parseInt(arg);
        });
    </script>
</head>
<body lang="zh-cn">
    <!--title -->
    <section class="hero is-link">
        <div class="hero-body">
            <div class="container">
                <div class="columns is-vcentered">
                    <div class="column">
                        <p class="title">
                            手写数字识别
                        </p>
                        <p class="subtitle">
                            Power by <strong>TensorFLow</strong>.这里想办法多写一点，不然不好看。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- nav -->
    <nav class="navbar has-shadow">
        <div class="container">
            <div class="navbar-tabs">
                <a class="navbar-item is-tab" href="index.html">
                    欢迎
                </a>
                <a class="navbar-item is-tab is-active" href="canvas.html">
                    画板
                </a>
                <!--<a class="navbar-item is-tab " href="camera.html">
                    摄像头
                </a>-->
                <a class="navbar-item is-tab" href="about.html">
                    关于
                </a>
            </div>
        </div>
    </nav>

    <!-- notification -->
    <div class="notification is-warning" hidden id="verror">
        <button class="delete" onclick="$('#verror').hide()" ></button>
        {{errorMsg}}
    </div>

    <!-- body -->
    <section class="section">
        <div class="columns">
            <div class="column is-two-thirds" id="mnist-image-column">
                <section class="hero is-link" >
                    <canvas class="image" id="mnist-image"></canvas>
                </section>
            </div>
            <div class="column">
                <div class="media-content bd-structure-item bd-is-structure-right">
                    <label class="label">原始图像</label>
                    <div align="center">
                        <figure class="image is-128x128">
                            <img id="inimg" src="res/128x128.png">
                        </figure>
                    </div>
                </div>
                <div class="media-content bd-structure-item bd-is-structure-right">
                    <label class="label">预处理</label>
                    <div align="center">
                        <figure class="image is-128x128">
                            <img id="preimg" src="res/128x128.png">
                        </figure>
                    </div>
                </div>
                <!--<div class="media-content bd-structure-item bd-is-structure-right">
                    <p>TensorFlow output:</p>
                    <div align="center">
                        </p><h1 class="title" id="vanswer" hidden>{{answer}}</h1></p>
                    </div>
                </div>-->
                <label class="label">识别结果</label>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <div class="select is-fullwidth">
                            <select id="number">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>    
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                            </select>
                        </div>
                    </div>
                    <div class="control" >
                        <button class="button is-warning" id="trainButton" onclick="trainNumber()">训练</button>
                    </div>
                </div>
                <div align="center">
                    <div class="button is-link is-large" id="verify" onclick="verifyNum()">识 别 数 字</div></p>
                    <a class="button is-danger is-outlined" onclick="context.clearRect(0,0,2000,1000)">
                        <span>清除</span>
                        <span class="icon is-small">
                            <i class="fa fa-times"></i>
                        </span>
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- canvas -->
    <script>
        //get canvas
        var canvas = document.getElementById("mnist-image")
        if (canvas == null)
            console.log('canvas init failed!')

        //set canvas resize on window size change
        window.onresize = function () {
            var canvasColumn = document.getElementById("mnist-image-column")
            canvas.width = canvasColumn.clientWidth;
            canvas.height = canvasColumn.clientHeight;
        }
        //resize to show
        window.onresize()

        //set draw status
        var drable = false;
        canvas.onmousedown = function () { drable = true }
        canvas.onmouseup = function () { drable = false }

        //draw
        canvas.onmousemove = function (e) {
            if (drable) {
                context.fillRect(e.layerX, e.layerY, 20, 20)
            }
        }

        //clear
        function clearConvas() {
            context.clearConvas();
        }

        var context = canvas.getContext('2d');
    </script>

    <!-- navs -->
    <script>

    </script>

    <!-- canvas input -->

    <!-- pre processing output -->

    <!-- tf answer -->
    <script>
        /*var vAnswer = new Vue({
            el: '#vanswer',
            data: {
                answer: 0
            }
        })*/

        var vErrorNoti = new Vue({
            el: '#verror',
            data: {
                errorMsg: '运行时发生错误'
            }
        })
        
    </script>

    <!-- verify -->
    <script>
        function verifyNum() {
            // todo:
            //start verify
            $('#verify')[0].onclick = null;
            $('#verify')[0].classList.add('is-loading')
            //show in img
            $('#inimg')[0].src = canvas.toDataURL("image/png");
            ipcRenderer.send('inimg', canvas.toDataURL("image/png"));
            //show pre img

            
        }
    </script>

    <!-- 训练 -->
    <script>
        function trainNumber()
        {
            $('#trainButton')[0].onclick = null;
            $('#trainButton')[0].classList.add('is-loading')
            ipcRenderer.send('train', $('#number')[0].value);
        }

        ipcRenderer.on('trainFin', function (event, arg) {
            $('#trainButton')[0].onclick = trainNumber;
            $('#trainButton')[0].classList.remove('is-loading')
            console.log(arg);
        });
    </script>

    <!-- footer -->
    <footer class="footer">
        <div class="container">
            <div class="content has-text-centered">
                <p>
                    <strong>MnistUi</strong> by <a href="http://jgthms.com">FeiLong</a>.
                </p>
            </div>
        </div>
    </footer>
</body>
</html>
